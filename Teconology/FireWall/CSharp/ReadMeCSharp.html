<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>readM.md—E:\program\防火墙\C#Operate\project\ConsoleApplication1</title>
    <style type="text/css">
    html{font-family: sans-serif;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%}body{margin: 0}article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display: block}audio,canvas,progress,video{display: inline-block;vertical-align: baseline}audio:not([controls]){display: none;height: 0}[hidden],template{display: none}a{background: transparent}a:active,a:hover{outline: 0}abbr[title]{border-bottom: 1px dotted}b,strong{font-weight: bold}dfn{font-style: italic}h1{font-size: 2em;margin: 0.67em 0}mark{background: #ff0;color: #000}small{font-size: 80%}sub,sup{font-size: 75%;line-height: 0;position: relative;vertical-align: baseline}sup{top: -0.5em}sub{bottom: -0.25em}img{border: 0}svg:not(:root){overflow: hidden}figure{margin: 1em 40px}hr{box-sizing: content-box;height: 0}pre{overflow: auto}code,kbd,pre,samp{font-family: monospace, monospace;font-size: 1em}button,input,optgroup,select,textarea{color: inherit;font: inherit;margin: 0}button{overflow: visible}button,select{text-transform: none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance: button;cursor: pointer}button[disabled],html input[disabled]{cursor: default}button::-moz-focus-inner,input::-moz-focus-inner{border: 0;padding: 0}input{line-height: normal}input[type="checkbox"],input[type="radio"]{box-sizing: border-box;padding: 0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height: auto}input[type="search"]{-webkit-appearance: textfield;box-sizing: content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance: none}fieldset{border: 1px solid #c0c0c0;margin: 0 2px;padding: 0.35em 0.625em 0.75em}legend{border: 0;padding: 0}textarea{overflow: auto}optgroup{font-weight: bold}table{border-collapse: collapse;border-spacing: 0}td,th{padding: 0}*{box-sizing: border-box}input,select,textarea,button{font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"}body{min-width: 1020px;font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";color: #333;background-color: #fff}a{color: #4183c4;text-decoration: none}a:hover,a:active{text-decoration: underline}hr,.rule{height: 0;margin: 15px 0;overflow: hidden;background: transparent;border: 0;border-bottom: 1px solid #ddd}hr:before,.rule:before{display: table;content: ""}hr:after,.rule:after{display: table;clear: both;content: ""}h1,h2,h3,h4,h5,h6{margin-top: 15px;margin-bottom: 15px;line-height: 1.1}h1{font-size: 30px}h2{font-size: 21px}h3{font-size: 16px}h4{font-size: 14px}h5{font-size: 12px}h6{font-size: 11px}small{font-size: 90%}blockquote{margin: 0}.lead{margin-bottom: 30px;font-size: 20px;font-weight: 300;color: #555}.text-muted{color: #999}.text-danger{color: #bd2c00}.text-emphasized{font-weight: bold;color: #333}ul,ol{padding: 0;margin-top: 0;margin-bottom: 0}ol ol,ul ol{list-style-type: lower-roman}ul ul ol,ul ol ol,ol ul ol,ol ol ol{list-style-type: lower-alpha}dd{margin-left: 0}tt,code{font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;font-size: 12px}pre{margin-top: 0;margin-bottom: 0;font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace}#realtime .status{overflow: visible;position: absolute;top: -5px;left: 0;background: url("/public/images/github-status.png");width: 26px;height: 26px;display: block;margin: 0 5px 0 0}#realtime .up{background-position: 0 0}#realtime .problem{background-position: 0 -53px}#realtime .down{background-position: 0 -26px}.container{max-width: 920px;margin: 0 auto 20px auto}#header{background: #FAFAFA;background: -moz-linear-gradient(#FAFAFA, #EAEAEA);background: -webkit-linear-gradient(#FAFAFA, #EAEAEA);-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr='#fafafa', endColorstr='#eaeaea')";border-bottom: 1px solid #CACACA;box-shadow: 0 1px 0 rgba(255, 255, 255, 0.4),0 0 10px rgba(0, 0, 0, 0.1)}#markup{padding: 3px}#markup article{padding-top: 30px}.markdown-body{overflow: hidden;font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;font-size: 16px;line-height: 1.6;word-wrap: break-word}.markdown-body>*:first-child{margin-top: 0 !important}.markdown-body>*:last-child{margin-bottom: 0 !important}.markdown-body .absent{color: #c00}.markdown-body .anchor{position: absolute;top: 0;left: 0;display: block;padding-right: 6px;padding-left: 30px;margin-left: -30px}.markdown-body .anchor:focus{outline: none}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position: relative;margin-top: 1em;margin-bottom: 16px;font-weight: bold;line-height: 1.4}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{display: none;color: #000;vertical-align: middle}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{padding-left: 8px;margin-left: -30px;text-decoration: none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{display: inline-block}.markdown-body h1 tt,.markdown-body h1 code,.markdown-body h2 tt,.markdown-body h2 code,.markdown-body h3 tt,.markdown-body h3 code,.markdown-body h4 tt,.markdown-body h4 code,.markdown-body h5 tt,.markdown-body h5 code,.markdown-body h6 tt,.markdown-body h6 code{font-size: inherit}.markdown-body h1{padding-bottom: 0.3em;font-size: 2.25em;line-height: 1.2;border-bottom: 1px solid #eee}.markdown-body h1 .anchor{line-height: 1}.markdown-body h2{padding-bottom: 0.3em;font-size: 1.75em;line-height: 1.225;border-bottom: 1px solid #eee}.markdown-body h2 .anchor{line-height: 1}.markdown-body h3{font-size: 1.5em;line-height: 1.43}.markdown-body h3 .anchor{line-height: 1.2}.markdown-body h4{font-size: 1.25em}.markdown-body h4 .anchor{line-height: 1.2}.markdown-body h5{font-size: 1em}.markdown-body h5 .anchor{line-height: 1.1}.markdown-body h6{font-size: 1em;color: #777}.markdown-body h6 .anchor{line-height: 1.1}.markdown-body p,.markdown-body blockquote,.markdown-body ul,.markdown-body ol,.markdown-body dl,.markdown-body table,.markdown-body pre{margin-top: 0;margin-bottom: 16px}.markdown-body hr{height: 4px;padding: 0;margin: 16px 0;background-color: #e7e7e7;border: 0 none}.markdown-body ul,.markdown-body ol{padding-left: 2em}.markdown-body ul.no-list,.markdown-body ol.no-list{padding: 0;list-style-type: none}.markdown-body ul ul,.markdown-body ul ol,.markdown-body ol ol,.markdown-body ol ul{margin-top: 0;margin-bottom: 0}.markdown-body li>p{margin-top: 16px}.markdown-body dl{padding: 0}.markdown-body dl dt{padding: 0;margin-top: 16px;font-size: 1em;font-style: italic;font-weight: bold}.markdown-body dl dd{padding: 0 16px;margin-bottom: 16px}.markdown-body blockquote{padding: 0 15px;color: #777;border-left: 4px solid #ddd}.markdown-body blockquote>:first-child{margin-top: 0}.markdown-body blockquote>:last-child{margin-bottom: 0}.markdown-body table{display: block;width: 100%;overflow: auto;word-break: normal;word-break: keep-all}.markdown-body table th{font-weight: bold}.markdown-body table th,.markdown-body table td{padding: 6px 13px;border: 1px solid #ddd}.markdown-body table tr{background-color: #fff;border-top: 1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color: #f8f8f8}.markdown-body img{max-width: 100%;box-sizing: border-box}.markdown-body span.frame{display: block;overflow: hidden}.markdown-body span.frame>span{display: block;float: left;width: auto;padding: 7px;margin: 13px 0 0;overflow: hidden;border: 1px solid #ddd}.markdown-body span.frame span img{display: block;float: left}.markdown-body span.frame span span{display: block;padding: 5px 0 0;clear: both;color: #333}.markdown-body span.align-center{display: block;overflow: hidden;clear: both}.markdown-body span.align-center>span{display: block;margin: 13px auto 0;overflow: hidden;text-align: center}.markdown-body span.align-center span img{margin: 0 auto;text-align: center}.markdown-body span.align-right{display: block;overflow: hidden;clear: both}.markdown-body span.align-right>span{display: block;margin: 13px 0 0;overflow: hidden;text-align: right}.markdown-body span.align-right span img{margin: 0;text-align: right}.markdown-body span.float-left{display: block;float: left;margin-right: 13px;overflow: hidden}.markdown-body span.float-left span{margin: 13px 0 0}.markdown-body span.float-right{display: block;float: right;margin-left: 13px;overflow: hidden}.markdown-body span.float-right>span{display: block;margin: 13px auto 0;overflow: hidden;text-align: right}.markdown-body code,.markdown-body tt{padding: 0;padding-top: 0.2em;padding-bottom: 0.2em;margin: 0;font-size: 85%;background-color: rgba(0,0,0,0.04);border-radius: 3px}.markdown-body code:before,.markdown-body code:after,.markdown-body tt:before,.markdown-body tt:after{letter-spacing: -0.2em;content: "\00a0"}.markdown-body code br,.markdown-body tt br{display: none}.markdown-body del code{text-decoration: inherit}.markdown-body pre>code{padding: 0;margin: 0;font-size: 100%;word-break: normal;white-space: pre;background: transparent;border: 0}.markdown-body .highlight{margin-bottom: 16px}.markdown-body .highlight pre,.markdown-body pre{padding: 16px;overflow: auto;font-size: 85%;line-height: 1.45;background-color: #f7f7f7;border-radius: 3px}.markdown-body .highlight pre{margin-bottom: 0;word-break: normal}.markdown-body pre{word-wrap: normal}.markdown-body pre code,.markdown-body pre tt{display: inline;max-width: initial;padding: 0;margin: 0;overflow: initial;line-height: inherit;word-wrap: normal;background-color: transparent;border: 0}.markdown-body pre code:before,.markdown-body pre code:after,.markdown-body pre tt:before,.markdown-body pre tt:after{content: normal}.markdown-body kbd{display: inline-block;padding: 3px 5px;font-size: 11px;line-height: 10px;color: #555;vertical-align: middle;background-color: #fcfcfc;border: solid 1px #ccc;border-bottom-color: #bbb;border-radius: 3px;box-shadow: inset 0 -1px 0 #bbb}.codehilite{background: #ffffff}.codehilite .c{color: #999988;font-style: italic}.codehilite .err{color: #a61717;background-color: #e3d2d2}.codehilite .k{color: #000000;font-weight: bold}.codehilite .o{color: #000000;font-weight: bold}.codehilite .cm{color: #999988;font-style: italic}.codehilite .cp{color: #999999;font-weight: bold}.codehilite .c1{color: #999988;font-style: italic}.codehilite .cs{color: #999999;font-weight: bold;font-style: italic}.codehilite .gd{color: #000000;background-color: #ffdddd}.codehilite .gd .x{color: #000000;background-color: #ffaaaa}.codehilite .ge{color: #000000;font-style: italic}.codehilite .gr{color: #aa0000}.codehilite .gh{color: #999999}.codehilite .gi{color: #000000;background-color: #ddffdd}.codehilite .gi .x{color: #000000;background-color: #aaffaa}.codehilite .go{color: #888888}.codehilite .gp{color: #555555}.codehilite .gs{font-weight: bold}.codehilite .gu{color: #aaaaaa}.codehilite .gt{color: #aa0000}.codehilite .kc{color: #000000;font-weight: bold}.codehilite .kd{color: #000000;font-weight: bold}.codehilite .kp{color: #000000;font-weight: bold}.codehilite .kr{color: #000000;font-weight: bold}.codehilite .kt{color: #445588;font-weight: bold}.codehilite .m{color: #009999}.codehilite .s{color: #d14}.codehilite .na{color: #008080}.codehilite .nb{color: #0086B3}.codehilite .nc{color: #445588;font-weight: bold}.codehilite .no{color: #008080}.codehilite .ni{color: #800080}.codehilite .ne{color: #990000;font-weight: bold}.codehilite .nf{color: #990000;font-weight: bold}.codehilite .nn{color: #555555}.codehilite .nt{color: #000080}.codehilite .nv{color: #008080}.codehilite .ow{color: #000000;font-weight: bold}.codehilite .w{color: #bbbbbb}.codehilite .mf{color: #009999}.codehilite .mh{color: #009999}.codehilite .mi{color: #009999}.codehilite .mo{color: #009999}.codehilite .sb{color: #d14}.codehilite .sc{color: #d14}.codehilite .sd{color: #d14}.codehilite .s2{color: #d14}.codehilite .se{color: #d14}.codehilite .sh{color: #d14}.codehilite .si{color: #d14}.codehilite .sx{color: #d14}.codehilite .sr{color: #009926}.codehilite .s1{color: #d14}.codehilite .ss{color: #990073}.codehilite .bp{color: #999999}.codehilite .vc{color: #008080}.codehilite .vg{color: #008080}.codehilite .vi{color: #008080}.codehilite .il{color: #009999}
    </style>
    <style type="text/css">
      .markdown-body hr{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC")}
    </style>
  </head>
  <body>
    <div class="container">
      <div id="markup">
        <article id="content" class="markdown-body">
          <h1>C# Fire Wall</h1>
<blockquote>
<p>C#修改防火墙主要用到了Windows提供的COM组件：NetFwTypeLib，因此使用C#操作防火墙时要注意添加引用:</br>
using NetFwTypeLib;本文罗列了以下文章的实现方法:</br></p>
</blockquote>
<h2>第一篇</h2>
<blockquote>
<p><a href="http://www.cnblogs.com/ITBread/archive/2012/04/29/2476170.html">C# 操作系统防火墙</a></br></p>
</blockquote>
<div class="codehilite"><pre>using System;
using System.Collections.Generic;
using System.Text;
using NetFwTypeLib;

namespace FireWallTest
{
    public  class FireWallHelp
    {
        /// &lt;summary&gt;
        /// 添加防火墙例外端口
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;名称&lt;/param&gt;
        /// &lt;param name=&quot;port&quot;&gt;端口&lt;/param&gt;
        /// &lt;param name=&quot;protocol&quot;&gt;协议(TCP、UDP)&lt;/param&gt;
        public static void NetFwAddPorts(string name, int port, string protocol)
        {
            //创建firewall管理类的实例
            INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));

            INetFwOpenPort objPort = (INetFwOpenPort)Activator.CreateInstance(
                Type.GetTypeFromProgID(&quot;HNetCfg.FwOpenPort&quot;));

            objPort.Name = name;
            objPort.Port = port;
            if (protocol.ToUpper() == &quot;TCP&quot;)
            {
                objPort.Protocol = NET_FW_IP_PROTOCOL_.NET_FW_IP_PROTOCOL_TCP;
            }
            else
            {
                objPort.Protocol = NET_FW_IP_PROTOCOL_.NET_FW_IP_PROTOCOL_UDP;
            }
            objPort.Scope = NET_FW_SCOPE_.NET_FW_SCOPE_ALL;
            objPort.Enabled = true;

            bool exist = false;
            //加入到防火墙的管理策略
            foreach (INetFwOpenPort mPort in netFwMgr.LocalPolicy.CurrentProfile.GloballyOpenPorts)
            {

                if (objPort == mPort)
                {
                    exist = true;
                    break;
                }
            }
            if (exist)
            {
                System.Windows.Forms.MessageBox.Show(&quot;exist&quot;); 
            }
            if (!exist) netFwMgr.LocalPolicy.CurrentProfile.GloballyOpenPorts.Add(objPort);
        }
        /// &lt;summary&gt;
        /// 将应用程序添加到防火墙例外
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;应用程序名称&lt;/param&gt;
        /// &lt;param name=&quot;executablePath&quot;&gt;应用程序可执行文件全路径&lt;/param&gt;
        public static void NetFwAddApps(string name, string executablePath)
        {
            //创建firewall管理类的实例
            INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));

            INetFwAuthorizedApplication app = (INetFwAuthorizedApplication)Activator.CreateInstance(
                Type.GetTypeFromProgID(&quot;HNetCfg.FwAuthorizedApplication&quot;));

            //在例外列表里，程序显示的名称
            app.Name = name;

            //程序的路径及文件名
            app.ProcessImageFileName = executablePath;

            //是否启用该规则
            app.Enabled = true;

            //加入到防火墙的管理策略
            netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications.Add(app);

            bool exist = false;
            //加入到防火墙的管理策略
            foreach (INetFwAuthorizedApplication mApp in netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications)
            {
                if (app == mApp)
                {
                    exist = true;
                    break;
                }
            }
            if (!exist) netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications.Add(app);
        }
        /// &lt;summary&gt;
        /// 删除防火墙例外端口
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;port&quot;&gt;端口&lt;/param&gt;
        /// &lt;param name=&quot;protocol&quot;&gt;协议（TCP、UDP）&lt;/param&gt;
        public static void NetFwDelApps(int port, string protocol)
        {
            INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));
            if (protocol == &quot;TCP&quot;)
            {
                netFwMgr.LocalPolicy.CurrentProfile.GloballyOpenPorts.Remove(port, NET_FW_IP_PROTOCOL_.NET_FW_IP_PROTOCOL_TCP);
            }
            else
            {
                netFwMgr.LocalPolicy.CurrentProfile.GloballyOpenPorts.Remove(port, NET_FW_IP_PROTOCOL_.NET_FW_IP_PROTOCOL_UDP);
            }
        }
        /// &lt;summary&gt;
        /// 删除防火墙例外中应用程序
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;executablePath&quot;&gt;程序的绝对路径&lt;/param&gt;
        public static void NetFwDelApps(string executablePath)
        {
            INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));

            netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications.Remove(executablePath);

        }
    }
}
http://www.cnblogs.com/ITBread/archive/2012/04/29/2476170.html
</pre></div>


<blockquote>
<p>由于其在运行过程中会出现问题故而原文作者对其进行了相关修改改进后的<a href="http://www.cnblogs.com/ITBread/archive/2012/07/30/2614996.html">地址</a></br>
由于使用C#需要管理员权限才能修改Firewall，综合考虑后还是没有使用该方法修改防火墙。</p>
</blockquote>
<h2>第二篇</h2>
<blockquote>
<p><a href="http://www.xuebuyuan.com/232586.htm">win7 添加白名单</a></p>
</blockquote>
<div class="codehilite"><pre>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.TeamFoundation.Common;

namespace FirewallAutomation
{
    class Program
    {
        static void Main(string[] args)
        {
            //创建防火墙管理器实例。这里用到了COM
            Type netfwType = Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;, false);
            INetFwMgr mgr = (INetFwMgr)Activator.CreateInstance(netfwType);

            //获取端口列表
            INetFwOpenPorts ports = (INetFwOpenPorts)mgr.LocalPolicy.CurrentProfile.GloballyOpenPorts;
            System.Collections.IEnumerator enumerate = ports.GetEnumerator();
            while (enumerate.MoveNext())
            {
                INetFwOpenPort port = (INetFwOpenPort)enumerate.Current;
                Console.WriteLine(&quot;Name:{0}  Protocol:{1}, Port:{2}&quot;, port.Name, port.Protocol.ToString(),port.Port);
            }

            //在入站规则中添加新的端口许可：TCP协议、8003端口
            INetFwOpenPort newPort = (INetFwOpenPort)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwOpenPort&quot;));
            newPort.Port = 8003;
            newPort.Name = &quot;放行8003&quot;;
            newPort.Protocol = NET_FW_IP_PROTOCOL_.NET_FW_IP_PROTOCOL_TCP;
            newPort.Enabled = true;
            ports.Add(newPort);

        }
    }
}
</pre></div>


<h2>第三篇</h2>
<blockquote>
<p><a href="http://www.cnblogs.com/shenblogs/archive/2016/05/13/5489161.html">C# open防火墙</a></br></p>
</blockquote>
<div class="codehilite"><pre>//开启服务、开启防火墙
        public void OpenFileWall()
        {
            // 1. 判断当前系统为XP或Win7
            RegistryKey rk = Registry.LocalMachine.OpenSubKey(@&quot;Software\\Microsoft\\Windows NT\\CurrentVersion&quot;);
            var VersionName = rk.GetValue(&quot;ProductName&quot;).ToString();
            rk.Close();
            RegistryKey key;
            //获取防火墙服务名称
            var ServicerName = &quot;&quot;;
            if (VersionName.Contains(&quot;XP&quot;))
            {
                ServicerName = &quot;SharedAccess&quot;;
                key = Registry.LocalMachine.OpenSubKey(@&quot;SYSTEM\\CurrentControlSet\\Services\\SharedAccess&quot;, true);
            }
            else
            {
                ServicerName = &quot;MpsSvc&quot;;
                key = Registry.LocalMachine.OpenSubKey(@&quot;SYSTEM\\CurrentControlSet\\Services\\MpsSvc&quot;, true);
            }
            // 2. 判断防火墙启动类型是否为禁止，若为禁止设置其为自动
            var StartIndex = key.GetValue(&quot;Start&quot;).ToString();
            if (StartIndex == &quot;4&quot;)
            {
                ProcessStartInfo objProInfo = new ProcessStartInfo();
                objProInfo.FileName = &quot;cmd.exe&quot;;
                objProInfo.CreateNoWindow = false;
                objProInfo.WindowStyle = ProcessWindowStyle.Hidden;
                objProInfo.Arguments = &quot;/c sc config &quot; + ServicerName + &quot; start= &quot; + &quot;auto&quot;;
                Process.Start(objProInfo);
                //挂起线程1s后启动服务
                System.Threading.Thread.Sleep(1000);
            }
            key.Close();
            // 3. 判断防火墙服务是否启动
            ServiceController sc = new ServiceController(ServicerName);
            if ((sc.Status.Equals(ServiceControllerStatus.Stopped)) || (sc.Status.Equals(ServiceControllerStatus.StopPending)))
            {
                sc.Start();
                //挂起线程1s后开启防火墙
                System.Threading.Thread.Sleep(1000);
            }
            // 4.开启防火墙
            if (VersionName.Contains(&quot;XP&quot;))
            {
                RegistryKey rekey = Registry.LocalMachine.OpenSubKey(@&quot;SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile&quot;, true);
                var Enablefilewall = rekey.GetValue(&quot;EnableFirewall&quot;).ToString();
                if (Enablefilewall == &quot;0&quot;)
                {
                    rekey.SetValue(&quot;EnableFirewall&quot;, 1);
                }
                rekey.Close();
            }
            else
            {
                INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
                // 启用&lt;高级安全Windows防火墙&gt; - 专有配置文件的防火墙
                firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, true);
                // 启用&lt;高级安全Windows防火墙&gt; - 公用配置文件的防火墙
                firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, true);
            }
        }

        //关闭防火墙
        public void CloseFileWall()
        {
            // 1. 判断当前系统为XP或Win7
            RegistryKey rk = Registry.LocalMachine.OpenSubKey(@&quot;Software\\Microsoft\\Windows NT\\CurrentVersion&quot;);
            var VersionName = rk.GetValue(&quot;ProductName&quot;).ToString();
            rk.Close();
            // 2.关闭防火墙
            if (VersionName.Contains(&quot;XP&quot;))
            {
                RegistryKey rekey = Registry.LocalMachine.OpenSubKey(@&quot;SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile&quot;, true);
                var Enablefilewall = rekey.GetValue(&quot;EnableFirewall&quot;).ToString();
                if (Enablefilewall == &quot;1&quot;)
                {
                    rekey.SetValue(&quot;EnableFirewall&quot;, 0);
                }
                rekey.Close();
            }
            else
            {
                INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
                // 禁用&lt;高级安全Windows防火墙&gt; - 专有配置文件的防火墙
                firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, false);
                // 禁用&lt;高级安全Windows防火墙&gt; - 公用配置文件的防火墙
                firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, false);
            }
        }

        //当检测不满足条件，阻止所有访问，只允许本程序运行
        public void UnAllowOpenFW()
        {
            //判断系统属于xp还是win7
            using (RegistryKey rk = Registry.LocalMachine.OpenSubKey(@&quot;Software\\Microsoft\\Windows NT\\CurrentVersion&quot;))
            {
                var VersionName = rk.GetValue(&quot;ProductName&quot;).ToString();
                if (VersionName.Contains(&quot;XP&quot;))
                {
                    // 1. 创建一个认证程序类的实例
                    INetFwAuthorizedApplication Fwapp = (INetFwAuthorizedApplication)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwAuthorizedApplication&quot;));
                    Fwapp.Name = &quot;360安全浏览器&quot;;
                    //Fwapp.Name = Application.ProductName;
                    Fwapp.ProcessImageFileName = &quot;C:\\Documents and Settings\\Administrator\\Application Data\\360se6\\Application\\360se.exe&quot;;
                    //Fwapp.ProcessImageFileName = Application.ExecutablePath;
                    //是否启用
                    Fwapp.Enabled = true;
                    // 2. 创建firewall管理类的实例 ，添加程序到防火墙例外
                    INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));
                    netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications.Add(Fwapp);
                }
                else
                {
                    // 1. 创建实例，阻止所有的出站连接 
                    INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
                    //启用或禁用&lt;高级安全Windows防火墙&gt; - 专有配置文件的出站连接
                    firewallPolicy.set_DefaultOutboundAction(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, NET_FW_ACTION_.NET_FW_ACTION_BLOCK);
                    //启用或禁用&lt;高级安全Windows防火墙&gt; - 公用配置文件的出站连接
                    firewallPolicy.set_DefaultOutboundAction(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, NET_FW_ACTION_.NET_FW_ACTION_BLOCK);
                    // 2. 创建本程序出站规则，只运行本程序的连接。
                    INetFwRule2 OutBoundRule = (INetFwRule2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FWRule&quot;));
                    OutBoundRule.Name = &quot;360安全浏览器&quot;;
                    //OutBoundRule.Name = Application.ProductName;
                    OutBoundRule.Description = &quot;360安全浏览器&quot;;
                    //程序路径
                    OutBoundRule.ApplicationName = &quot;C:\\Users\\Administrator\\AppData\\Roaming\\360se6\\Application\\360se.exe&quot;;
                    //OutBoundRule.ApplicationName = Application.ExecutablePath;
                    OutBoundRule.Direction = NET_FW_RULE_DIRECTION_.NET_FW_RULE_DIR_OUT;
                    OutBoundRule.Action = NET_FW_ACTION_.NET_FW_ACTION_ALLOW;
                    OutBoundRule.Enabled = true;
                    // 3.添加出站规则
                    firewallPolicy.Rules.Add(OutBoundRule);
                }
            }
        }

        //检测满足条件，开启所有访问
        public void AllowOpenFW()
        {
            //判断系统属于xp还是win7
            using (RegistryKey rk = Registry.LocalMachine.OpenSubKey(@&quot;Software\\Microsoft\\Windows NT\\CurrentVersion&quot;))
            {
                var ApplicationName = &quot;360安全浏览器&quot;;
                // var ApplicationName = Application.ProductName;
                var VersionName = rk.GetValue(&quot;ProductName&quot;).ToString();
                if (VersionName.Contains(&quot;XP&quot;))
                {
                    // 创建firewall管理类的实例 ，删除添加程序到防火墙例外
                    INetFwMgr netFwMgr = (INetFwMgr)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwMgr&quot;));
                    netFwMgr.LocalPolicy.CurrentProfile.AuthorizedApplications.Remove(ApplicationName);
                }
                else
                {
                    // 1. 创建实例，允许所有程序的连接。
                    INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
                    //启用或禁用&lt;高级安全Windows防火墙&gt; - 专有配置文件的出站连接
                    firewallPolicy.set_DefaultOutboundAction(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, NET_FW_ACTION_.NET_FW_ACTION_ALLOW);
                    //启用或禁用&lt;高级安全Windows防火墙&gt; - 公用配置文件的出站连接
                    firewallPolicy.set_DefaultOutboundAction(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, NET_FW_ACTION_.NET_FW_ACTION_ALLOW);
                    // 2. 删除本程序的出站规则删除规则
                    firewallPolicy.Rules.Remove(ApplicationName);
                }
            }
        }
</pre></div>


<h2>根据第三篇实现的防火墙状态判断</h2>
<div class="codehilite"><pre>using System;
using System.Collections.Generic;
using System.Text;
using NetFwTypeLib;
using Microsoft.Win32;
using System.Diagnostics;
using System.ServiceProcess;
//引用命名空间

static void openfirewallMy()
{
    INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
    // 启用&lt;高级安全Windows防火墙&gt; - 专有配置文件的防火墙
    firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, true);
    // 启用&lt;高级安全Windows防火墙&gt; - 公用配置文件的防火墙
    firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, true);
}
static void closefilerwallMy()
{
    INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
    // 禁用&lt;高级安全Windows防火墙&gt; - 专有配置文件的防火墙
    firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE, false);
    // 禁用&lt;高级安全Windows防火墙&gt; - 公用配置文件的防火墙
    firewallPolicy.set_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PUBLIC, false);
}

public static bool CheckFireWallServiceOpened()
{
    string ServicerName = &quot;MpsSvc&quot;;
    // 3. 判断防火墙服务是否启动
    ServiceController sc = new ServiceController(ServicerName);
    if ((sc.Status.Equals(ServiceControllerStatus.Stopped)) || (sc.Status.Equals(ServiceControllerStatus.StopPending)))
    {
        //sc.Start();
        //挂起线程1s后开启防火墙
        //System.Threading.Thread.Sleep(1000);
        return false;
    }
    else
    {
        return true;
    }
}
public static bool CheckFireWallOpened()
{
     INetFwPolicy2 firewallPolicy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID(&quot;HNetCfg.FwPolicy2&quot;));
    // 禁用&lt;高级安全Windows防火墙&gt; - 专有配置文件的防火墙
    return firewallPolicy.get_FirewallEnabled(NET_FW_PROFILE_TYPE2_.NET_FW_PROFILE2_PRIVATE);
}
</pre></div>


<blockquote>
<p>在实现过程中用到了ServiceProcess组件，因此在使用是要添加.net组件。不然using System.ServiceProcess会出错</br></p>
</blockquote>
<h2>说明</h2>
<blockquote>
<p>本文主要是根据项目过程中对修改Windows防火墙相关技术学习的初步总结，避免后期忘记而做的简单笔记</br>
对所参考的原创作者致以敬意，以后若有所思，一定继续完善该文档，形成自己的风格，做自己的创作</br></p>
</blockquote>
<h2>Reference</h2>
<p><a href="http://www.cnblogs.com/ITBread/archive/2012/04/29/2476170.html">C# 操作系统防火墙</a></br>
<a href="http://www.cnblogs.com/ITBread/archive/2012/07/30/2614996.html">C# 操作系统防火墙2</a></br>
<a href="http://www.cnblogs.com/shenblogs/archive/2016/05/13/5489161.html">C# open防火墙</a></br></p>
        </article>
      </div>
    </div>
  </body>
</html>
